---
title: "AMS-III.G Landfill Methane Recovery Workflow"
author: "OpenAI Assistant"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AMS-III.G Landfill Methane Recovery Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

AMS-III.G covers project activities that recover and destroy landfill methane. This vignette demonstrates how `cdmAmsIIIg` operationalises the methodology with tidyverse data structures and composable helpers.

# Simulate Monitoring Data

```{r simulate}
library(cdmAmsIIIg)
library(dplyr)

simulated <- simulate_ams_iiig_dataset(n_sites = 2, n_periods = 2, seed = 2025)
str(simulated, max.level = 1)
```

# Check Applicability

```{r applicability}
landfill <- check_applicability_landfill_characteristics_iiig(simulated$applicability, group_cols = "site_id")
gas <- check_applicability_gas_management_iiig(simulated$applicability, group_cols = "site_id")
monitoring <- check_applicability_monitoring_framework_iiig(simulated$applicability, group_cols = "site_id")

applicability <- landfill %>%
  left_join(gas, by = "site_id") %>%
  left_join(monitoring, by = "site_id")

applicability
```

# Run Equation Helpers

```{r helpers}
baseline <- calculate_baseline_methane_emissions_iiig(
  simulated$baseline,
  group_cols = "site_id",
  days_col = "days_in_period"
)
project <- calculate_project_emissions_iiig(
  simulated$project,
  group_cols = "site_id",
  days_col = "days_in_period"
)
leakage <- calculate_leakage_emissions_iiig(simulated$leakage, group_cols = "site_id")

dplyr::bind_cols(baseline, project[-1], leakage[-1])
```

# Estimate Emission Reductions

```{r workflow}
reductions <- estimate_emission_reductions_ams_iiig(
  baseline_data = simulated$baseline,
  project_data = simulated$project,
  leakage_data = simulated$leakage,
  group_cols = "site_id",
  baseline_args = list(days_col = "days_in_period"),
  project_args = list(days_col = "days_in_period")
)

reductions
```

# Aggregate Monitoring Periods

```{r aggregate}
baseline_period <- calculate_baseline_methane_emissions_iiig(
  simulated$baseline,
  group_cols = c("site_id", "period"),
  days_col = "days_in_period"
)
project_period <- calculate_project_emissions_iiig(
  simulated$project,
  group_cols = c("site_id", "period"),
  days_col = "days_in_period"
)
leakage_period <- calculate_leakage_emissions_iiig(
  simulated$leakage,
  group_cols = c("site_id", "period")
)

period_results <- baseline_period %>%
  left_join(project_period, by = c("site_id", "period")) %>%
  left_join(leakage_period, by = c("site_id", "period")) %>%
  mutate(monitoring_period = period)

aggregate_monitoring_periods_iiig(
  period_results,
  group_cols = "site_id",
  monitoring_col = "monitoring_period"
)
```

The helpers and workflow wrapper simplify reproducing AMS-III.G calculations with tidy inputs while providing traceable applicability evidence.

---
title: "AMS-II.H Methodology Walkthrough"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AMS-II.H Methodology Walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r kable-helper, include = FALSE}
quiet_kable <- function(...) suppressWarnings(knitr::kable(...))
```


# Introduction

This vignette demonstrates how to reproduce the AMS-II.H calculations using
`cdmAmsIIh`. The methodology covers projects that centralize the provision of
utilities (steam, hot water, chilled water) previously generated by multiple
stand-alone units. The workflow contrasts decentralized baseline emissions with
the centralized project's fuel and auxiliary electricity demand, applies leakage
adjustments, and reports the resulting emission reductions.

# Applicability Checks

```{r applicability}
library(cdmAmsIIh)

baseline_scope <- tibble::tibble(
  utility_service = c("steam", "hot_water"),
  baseline_unit_count = c(4, 3)
)
project_scope <- tibble::tibble(
  utility_service = c("steam", "hot_water"),
  project_unit_count = c(1, 1)
)
monitoring_snapshot <- tibble::tibble(
  baseline_fuel_use_gj = 4200,
  baseline_emission_factor_tco2_per_gj = 0.071,
  project_fuel_use_gj = 3000,
  project_emission_factor_tco2_per_gj = 0.068
)
baseline_specific <- tibble::tibble(
  facility = c("Line_A", "Line_B"),
  baseline_fuel_use_gj = c(4200, 3150),
  baseline_useful_output_gj = c(3600, 2700)
)
project_specific <- tibble::tibble(
  facility = c("Line_A", "Line_B"),
  project_fuel_use_gj = c(3000, 2250),
  project_useful_output_gj = c(2880, 2160)
)

check_applicability_centralization_scope_iih(baseline_scope, project_scope)
check_applicability_monitoring_iih(monitoring_snapshot)
check_applicability_efficiency_improvement_iih(
  baseline_specific,
  project_specific,
  group_cols = "facility",
  minimum_improvement = 0.05
)
```

# Simulated Dataset

```{r simulation}
set.seed(123)
inputs <- simulate_ams_iih_inputs(n_facilities = 3, seed = 123)
quiet_kable(inputs$baseline_data, format = "html", digits = 2)
```

The simulation returns baseline, project, and leakage datasets for each
facility, including fuel use, emission factors, useful output, auxiliary
electricity, and leakage placeholders.

# Equation Walkthrough

```{r equations}
baseline_emissions <- calculate_baseline_decentralized_emissions_iih(
  inputs$baseline_data,
  group_cols = "facility"
)
project_central <- calculate_project_central_emissions_iih(
  inputs$project_data,
  group_cols = "facility"
)
project_auxiliary <- calculate_project_auxiliary_electricity_iih(
  inputs$project_data,
  group_cols = "facility"
)
project_totals <- project_central |>
  dplyr::left_join(project_auxiliary, by = "facility") |>
  dplyr::mutate(
    project_emissions_tco2e = dplyr::coalesce(project_central_emissions_tco2e, 0) +
      dplyr::coalesce(project_auxiliary_emissions_tco2e, 0)
  )
leakage_totals <- inputs$leakage_data

emission_reductions <- calculate_emission_reductions_iih(
  baseline_emissions = baseline_emissions,
  project_emissions = project_totals |>
    dplyr::select(facility, project_emissions_tco2e),
  leakage_emissions = leakage_totals,
  group_cols = "facility"
)

walkthrough_results <- baseline_emissions |>
  dplyr::left_join(project_totals, by = "facility") |>
  dplyr::left_join(leakage_totals, by = "facility") |>
  dplyr::left_join(emission_reductions, by = "facility")

quiet_kable(walkthrough_results, format = "html", digits = 3)
```

# Monitoring Period Aggregation

```{r monitoring}
monitoring_summary <- inputs$baseline_data |>
  dplyr::left_join(inputs$project_data, by = "facility", suffix = c("_baseline", "_project")) |>
  dplyr::left_join(inputs$leakage_data, by = "facility")

quiet_kable(monitoring_summary, format = "html", digits = 2)
```

# Meta-Function

```{r meta}
estimate_emission_reductions_ams_iih(
  baseline_data = inputs$baseline_data,
  project_data = inputs$project_data,
  leakage_data = inputs$leakage_data,
  group_cols = "facility"
)
```

# Function Reference

```{r reference}
function_reference <- tibble::tibble(
  Function = c(
    "`calculate_baseline_decentralized_emissions_iih()`",
    "`calculate_project_central_emissions_iih()`",
    "`calculate_project_auxiliary_electricity_iih()`",
    "`calculate_emission_reductions_iih()`",
    "`estimate_emission_reductions_ams_iih()`",
    "`simulate_ams_iih_inputs()`"
  ),
  Signature = c(
    "`calculate_baseline_decentralized_emissions_iih(baseline_data, fuel_consumption_col = \"baseline_fuel_use_gj\", emission_factor_col = \"baseline_emission_factor_tco2_per_gj\", useful_output_col = \"baseline_useful_output_gj\", group_cols = NULL, output_col = \"baseline_emissions_tco2e\", specific_energy_col = \"baseline_specific_energy_gj_per_gj\")`",
    "`calculate_project_central_emissions_iih(project_data, fuel_consumption_col = \"project_fuel_use_gj\", emission_factor_col = \"project_emission_factor_tco2_per_gj\", useful_output_col = \"project_useful_output_gj\", group_cols = NULL, output_col = \"project_central_emissions_tco2e\", specific_energy_col = \"project_specific_energy_gj_per_gj\")`",
    "`calculate_project_auxiliary_electricity_iih(project_data, electricity_consumption_col = \"project_auxiliary_electricity_mwh\", emission_factor_col = \"project_electricity_emission_factor_tco2_per_mwh\", group_cols = NULL, output_col = \"project_auxiliary_emissions_tco2e\")`",
    "`calculate_emission_reductions_iih(baseline_emissions, project_emissions, leakage_emissions = NULL, group_cols = NULL, output_col = \"emission_reductions_tco2e\")`",
    "`estimate_emission_reductions_ams_iih(baseline_data, project_data, leakage_data = NULL, group_cols = NULL, baseline_fuel_consumption_col = \"baseline_fuel_use_gj\", baseline_emission_factor_col = \"baseline_emission_factor_tco2_per_gj\", baseline_useful_output_col = \"baseline_useful_output_gj\", project_fuel_consumption_col = \"project_fuel_use_gj\", project_emission_factor_col = \"project_emission_factor_tco2_per_gj\", project_useful_output_col = \"project_useful_output_gj\", project_aux_electricity_col = \"project_auxiliary_electricity_mwh\", project_electricity_emission_factor_col = \"project_electricity_emission_factor_tco2_per_mwh\", leakage_col = \"leakage_emissions_tco2e\")`",
    "`simulate_ams_iih_inputs(n_facilities = 4, seed = NULL, baseline_fuel_mean = 4200, central_efficiency_gain = 0.35, electricity_intensity = 0.045, leakage_fraction = 0.02)`"
  ),
  Purpose = c(
    "Summarises decentralized baseline fuel use and emissions, optionally reporting specific energy.<br>\\(BE_y = \\sum_i FC^{BL}_{i,y} \\times EF^{BL}_{i,y}\\)",
    "Quantifies emissions from the centralized utility system implemented by the project.<br>\\(PE^{central}_y = \\sum_i FC^{PR}_{i,y} \\times EF^{PR}_{i,y}\\)",
    "Converts auxiliary electricity consumption into project emissions using grid factors.<br>\\(PE^{aux}_y = \\sum_i EC^{aux}_{i,y} \\times EF^{grid}_{i,y}\\)",
    "Combines baseline, project, and leakage emissions to obtain net reductions.<br>\\(ER_y = BE_y - (PE^{central}_y + PE^{aux}_y + LE_y)\\)",
    "Meta-function chaining the AMS-II.H equation helpers into a tidy workflow.<br>\\(ER_y = BE_y - (PE^{central}_y + PE^{aux}_y + LE_y)\\)",
    "Generates representative baseline, project, and leakage datasets for demonstrations and tests."
  )
)

quiet_kable(function_reference, format = "html", escape = FALSE)
```

# Workflow Overview

```{r workflow-overview, echo = FALSE}
workflow_steps <- tibble::tibble(
  Step = c(
    "Input decentralized and centralized monitoring data",
    "calculate_baseline_decentralized_emissions_iih",
    "calculate_project_central_emissions_iih",
    "calculate_project_auxiliary_electricity_iih",
    "calculate_emission_reductions_iih",
    "estimate_emission_reductions_ams_iih"
  ),
  Purpose = c(
    "Collect fuel, emission factor, useful output, and leakage metrics for each facility.",
    "Translate baseline decentralized operation into emissions and diagnostics.",
    "Summarise centralized project fuel emissions and optional specific energy.",
    "Quantify auxiliary electricity emissions associated with distribution equipment.",
    "Subtract project and leakage emissions from the baseline totals to obtain reductions.",
    "Return a tidy tibble combining baseline, project, leakage, and reduction metrics."
  )
)

quiet_kable(workflow_steps, format = "html", escape = FALSE)
```

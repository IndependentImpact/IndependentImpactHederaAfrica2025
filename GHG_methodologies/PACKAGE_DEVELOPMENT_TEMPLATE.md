# CDM Methodology Package Development Template

This repository hosts a collection of R packages implementing CDM methodologies. Every package **must** follow the conventions in this document to ensure consistency across the ecosystem.

## 1. General Structure
- Each methodology lives in its own installable R package stored in a dedicated subdirectory of the repository root.
- Package names should be lowercase, hyphen-free, and prefixed with `cdm` and in camelCase(e.g. `cdm-methane-leaks` becomes `cdmMethaneLeaks`).
- Packages must adopt the standard R package layout generated by `usethis::create_package()`.
- Include a `DESCRIPTION` file with complete metadata, dependencies, and authorship information. Default author in independentimpact.org

## 2. Dependencies and Integration
- Depend on the **tidyverse** meta-package to ensure seamless integration with the tidyverse family of packages. Prefer tidyverse-native tools (`dplyr`, `tidyr`, `stringr`, `purrr`, etc.) for data manipulation, string handling, and functional programming.
- Use `DeclareDesign` for simulation tasks. Add it to the `Suggests` field of `DESCRIPTION` and conditionally load it within examples/tests.
- Any additional dependencies must be justified in package documentation.

## 3. Function Design Requirements
- Translate **every numbered equation** in the methodology documentation into a dedicated R function stored under `R/`.
- Provide **meta-functions** that orchestrate the full calculation by composing the equation-level functions.
- Implement helper functions that evaluate **quantitative applicability conditions** described in the methodology.
- Include monitoring-period aggregation helpers that roll simulated or observed data up to reporting periods using the
  equation-level functions.
- All functions must:
  - Accept tidy data frames (tibbles) as appropriate and return tidyverse-compatible structures.
  - Be vectorised where possible and avoid hidden state.
  - Contain complete `@param`, `@return`, `@examples`, and `@seealso` tags in their Roxygen documentation. Use parameter descriptions to reference outputs from related functions when arguments depend on previous results.

## 4. Documentation Standards
- Use **Roxygen2** for all function documentation. Run `devtools::document()` (or `roxygen2::roxygenise()`) to generate Rd files before committing.
- Each package requires a `pkgdown`-ready `README.Rmd` summarising the methodology, inputs, outputs, and tidyverse alignment.
- Maintain a NEWS.md changelog with semantic versioning notes.

## 5. Testing and Quality Assurance
- Provide unit tests in `tests/testthat/` for **every** function, including numerical tolerances for equation implementations and end-to-end tests for meta-functions.
- Test applicability-condition functions with both valid and invalid inputs.
- Ensure simulated datasets generated by DeclareDesign are validated within tests (e.g. checking column presence and summary statistics).
- Configure continuous integration (e.g. GitHub Actions) to run `R CMD check --as-cran` for each package.

## 6. Simulation Utilities
- Each package must expose at least one `simulate_*()` function that creates a test dataset using `DeclareDesign` reflecting the methodology's data requirements.
- Simulations must emit temporal monitoring metadata (e.g. day, month, and year) so that reporting-period summaries can be reproduced in tests and documentation.
- Document simulation parameters and default values, emphasising tidyverse compatibility.

## 7. Vignettes
- Create a vignette (`vignettes/<package>-methodology.Rmd`) that mirrors the AMS-I.A example. The structure must include, in
  order:
  1. **Introduction** — narrative description of the methodology and its data requirements.
  2. **Applicability Checks** — runnable examples for each applicability helper.
  3. **Simulated Dataset** — generation of the package's simulated data with `knitr::kable()` output.
  4. **Equation Walkthrough** — sequential execution of the equation-level helpers.
  5. **Monitoring Period Aggregation** — demonstration of `aggregate_monitoring_periods()` or the package-specific wrapper.
  6. **Meta-Function** — call to the high-level estimator tying the helpers together.
  7. **Function Reference** — a table with exactly three columns (`Function`, `Signature`, `Purpose`) rendered via
     `knitr::kable()`.
  8. **Workflow Overview** — a tabular summary of the end-to-end steps.
- Optional diagrams (e.g. Mermaid flowcharts) can be included in the workflow section but should not replace the required
  subsections.

## 8. Workflow Checklist
1. Generate the package skeleton with `usethis::create_package()`.
2. Implement equation functions, meta-functions, and applicability checks under `R/`.
3. Add Roxygen documentation with tidyverse-focused parameter descriptions.
4. Create DeclareDesign-based simulation utilities.
5. Write unit tests for all functionality using `testthat`.
6. Produce a vignette with narrative, examples, and a diagram.
7. Run `devtools::document()` and `devtools::check()`.
8. Update README, NEWS, and pkgdown configuration as needed.
9. Commit changes and open a PR summarising updates.

## 9. pkgdown Publishing Pipeline
- Use the shared automation in `tools/pkgdown/` to scaffold and publish documentation sites for every methodology package.
- Run `Rscript tools/pkgdown/scaffold_pkgdown_yml.R` (set `PKGDOWN_GITHUB_ORG` in your environment first) to generate or refresh
  each package's `_pkgdown.yml` from the repository template.
- Add pkgdown metadata to `DESCRIPTION` (e.g. `pkgdown` and `whisker` in `Suggests`) and include the pkgdown status badge in the
  package `README`.
- For local QA, execute `Rscript tools/pkgdown/preview_all_pkgdown.R` to render every site into `docs/<package>/`.
- The GitHub Actions workflow `.github/workflows/pkgdown-matrix.yml` automatically runs `tools/pkgdown/build_single_pkgdown.R`
  for each package on pushes to `main`, publishing the rendered site to the shared `gh-pages` branch at
  `https://<org>.github.io/GHG_methodologies/sites/<package>/`.
- Trigger manual rebuilds with `gh workflow run pkgdown-matrix --ref main` when you need to regenerate a site outside the
  normal push workflow.

Adhering to this template ensures every CDM methodology package remains consistent, well-documented, and immediately usable by analysts working within the tidyverse ecosystem.
